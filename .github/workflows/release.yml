name: Release

on:
    pull_request:
        types: [closed]
        branches: [main]

permissions:
    contents: write

jobs:
    release:
        if: github.event.pull_request.merged == true
        runs-on: ubuntu-latest

        steps:
            - name: Checkout Code
              uses: actions/checkout@v2
              with:
                  fetch-depth: 0

            - name: Set Go Version
              uses: actions/setup-go@v2
              with:
                  go-version: 1.25.4

            - name: Set Git Identity
              run: |
                  git config --global user.name "Raywall Malheiros"
                  git config --global user.email "raywall.malheiros@gmail.com"

            - name: Get Previous Tag
              id: previous_tag
              run: |
                  previous_tag=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
                  echo "previous_tag=$previous_tag" >> $GITHUB_OUTPUT

            - name: Increment Version and Create Tag
              id: create_tag
              run: |
                  previous_version="${{ steps.previous_tag.outputs.previous_tag }}"
                  new_tag=""

                  if [ "$previous_version" = "v0.0.0" ]; then
                      # Se for a primeira tag (retornada como v0.0.0), defina como v1.0.0
                      new_tag="v1.0.0"
                  else
                      # Se j√° houver uma tag, incremente o patch
                      # Remove o 'v' para processamento
                      version_without_v=${previous_version:1}
                      
                      # Usamos IFS para separar Major, Minor, Patch
                      IFS='.' read -r major minor patch <<< "$version_without_v"
                      
                      next_patch=$((patch + 1))
                      new_tag="v${major}.${minor}.${next_patch}"
                  fi

                  echo "new_tag=$new_tag" >> $GITHUB_OUTPUT
                  echo "Creating tag: $new_tag"
                  git tag "$new_tag"
                  git push --tags
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Create Release with GoReleaser
              uses: goreleaser/goreleaser-action@v6
              with:
                  distribution: goreleaser
                  version: "latest"
                  args: release --clean
              env:
                  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

            - name: Request a Package Update
              run: curl "https://proxy.golang.org/github.com/${{ github.repository }}/@v/${{ steps.create_tag.outputs.new_tag }}.info"
