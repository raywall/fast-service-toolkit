name: Release Go Package

on:
    workflow_call:
        inputs:
            go_version:
                required: true
                type: string
            new_tag:
                required: true
                type: string
            goreleaser_config:
                required: false
                default: "./.goreleaser.yml"
                type: string
            snapshot:
                required: false
                default: false
                type: boolean
            skip_publish:
                required: false
                default: false
                type: boolean

        outputs:
            release_url:
                description: "Release URL"
                value: ${{ jobs.create-release.outputs.release_url }}
            assets_count:
                description: "Number of assets"
                value: ${{ jobs.create-release.outputs.assets_count }}

jobs:
    create-release:
        runs-on: ubuntu-latest
        outputs:
            release_url: ${{ steps.release-info.outputs.release_url }}
            assets_count: ${{ steps.release-info.outputs.assets_count }}

        steps:
            - name: ğŸ“¥ Checkout code
              uses: actions/checkout@v4
              with:
                  fetch-depth: 0

            - name: âš™ï¸ Setup Go ${{ inputs.go_version }}
              uses: actions/setup-go@v5
              with:
                  go-version: ${{ inputs.go_version }}

            - name: ğŸ“¦ Download dependencies
              run: go mod download

            - name: ğŸ”§ Install GoReleaser
              uses: goreleaser/goreleaser-action@v6
              with:
                  distribution: goreleaser
                  version: "latest"
                  install-only: true

            - name: ğŸš€ Create release
              id: goreleaser
              run: |
                  ARGS="release --clean"

                  if ${{ inputs.snapshot }}; then
                    ARGS="$ARGS --snapshot"
                  fi

                  if ${{ inputs.skip_publish }}; then
                    ARGS="$ARGS --skip=publish"
                  fi

                  if [ -f "${{ inputs.goreleaser_config }}" ]; then
                    ARGS="$ARGS --config ${{ inputs.goreleaser_config }}"
                    echo "ğŸ“„ Using config: ${{ inputs.goreleaser_config }}"
                  else
                    echo "âš ï¸ No goreleaser config found, using defaults"
                  fi

                  echo "Running: goreleaser $ARGS"
                  goreleaser $ARGS

            - name: ğŸ“‹ Get release info
              id: release-info
              run: |
                  # Extrair informaÃ§Ãµes da release
                  RELEASE_URL="https://github.com/${{ github.repository }}/releases/tag/${{ inputs.new_tag }}"
                  echo "release_url=$RELEASE_URL" >> $GITHUB_OUTPUT

                  # Contar assets (exemplo - pode precisar de ajuste)
                  echo "assets_count=unknown" >> $GITHUB_OUTPUT

                  echo "âœ… Release created: $RELEASE_URL"

            - name: ğŸ“ Upload release artifacts
              if: always()
              uses: actions/upload-artifact@v4
              with:
                  name: release-artifacts
                  path: |
                      dist/
                      .goreleaser*.yml
                  retention-days: 90
